@page "/guide/{**slug}"
@using Microsoft.AspNetCore.Components.Web
@using downpatch.Data
@using downpatch.Services
@inject MarkdownStore Store
@inject MarkdownRenderer Renderer
@inject NavigationManager Nav
@inject IHttpContextAccessor HttpContextAccessor
@inject SiteBranding Brand

<PageTitle>@_pageTitleFull</PageTitle>

<HeadContent>
    @* Basic *@
    <meta name="application-name" content="@Brand.SiteName" />
    @if (!string.IsNullOrWhiteSpace(Brand.ThemeColor))
    {
        <meta name="theme-color" content="@Brand.ThemeColor" />
    }

    @if (!string.IsNullOrWhiteSpace(_canonical))
    {
        <link rel="canonical" href="@_canonical" />
        <meta property="og:url" content="@_canonical" />
    }

    @if (!string.IsNullOrWhiteSpace(_description))
    {
        <meta name="description" content="@_description" />
    }

    @* Social cards *@
    <meta property="og:site_name" content="@Brand.SiteName" />
    <meta property="og:title" content="@_pageTitleFull" />
    <meta property="og:type" content="article" />

    @if (!string.IsNullOrWhiteSpace(_description))
    {
        <meta property="og:description" content="@_description" />
    }

    @{
        var ogImage = !string.IsNullOrWhiteSpace(_ogImage) ? _ogImage : Brand.DefaultOgImage;
        var squareImage = !string.IsNullOrWhiteSpace(_squareImage) ? _squareImage : "";
    }

    @if (!string.IsNullOrWhiteSpace(ogImage))
    {
        <meta property="og:image" content="@ToAbsolute(ogImage)" />
        <meta name="twitter:card" content="summary_large_image" />
    }

    @if (!string.IsNullOrWhiteSpace(squareImage))
    {
        <meta property="og:image" content="@ToAbsolute(squareImage)" />
        <meta property="og:image:width" content="1024" />
        <meta property="og:image:height" content="1024" />


        <link rel="icon"
              type="image/webp"
              href="@ToAbsolute(_squareImage)" />

        <link rel="apple-touch-icon"
              href="@ToAbsolute(_squareImage)" />

        <meta name="msapplication-TileImage"
              content="@ToAbsolute(_squareImage)" />
    }


    <meta name="twitter:title" content="@_pageTitleFull" />
    @if (!string.IsNullOrWhiteSpace(_description))
    {
        <meta name="twitter:description" content="@_description" />
    }

    @if (!string.IsNullOrWhiteSpace(Brand.TwitterHandle))
    {
        <meta name="twitter:site" content="@Brand.TwitterHandle" />
    }

    @if (_noIndex)
    {
        <meta name="robots" content="noindex,nofollow" />
    }

    @* JSON-LD *@
    <script type="application/ld+json">@_jsonLd</script>
</HeadContent>


@if (_notFound)
{
    <h1>Not found</h1>
    <p>That page doesn’t exist.</p>
}
else if (_html is null)
{
    <p>Loading...</p>
}
else
{
    <a class="skip-link" href="#doc-content">Skip to content</a>

    <header class="doc-hero2" style="@HeroStyle" aria-labelledby="doc-title">
        <div class="doc-hero2-inner">
            <div class="doc-hero2-meta">
                <p class="doc-kicker">Guide</p>
                <h1 id="doc-title" class="doc-title">@_title</h1>

                @if (!string.IsNullOrWhiteSpace(_description))
                {
                    <p class="doc-lead">@_description</p>
                }

                <div class="doc-actions" role="navigation" aria-label="Document actions">
                    <a class="doc-action" href="/guide">All guides</a>
                    @if (!string.IsNullOrWhiteSpace(_canonical))
                    {
                        <a class="doc-action" href="@_canonical">Permalink</a>
                    }
                </div>
            </div>
        </div>
    </header>

    <div class="doc-shell">
        @if (_nav is not null)
        {
            <nav class="doc-nav" aria-label="Guide navigation">
                <div class="nav-card">
                    <div class="nav-head">
                        <h2 class="nav-title">Contents</h2>
                    </div>

                    <div class="nav-body">
                        <ul class="nav-list">
                            <li class="nav-item">
                                <a class="nav-link @(_nav.IsCurrent ? "is-current" : "")"
                                   href="@ToGuideRoute(_nav.Slug)"
                                   aria-current="@(_nav.IsCurrent ? "page" : null)">
                                    @_nav.Title
                                </a>
                            </li>
                        </ul>

                        @if (_nav.Children.Any())
                        {
                            @RenderNav(_nav)
                        }
                    </div>
                </div>
            </nav>
        }

        <main id="doc-content" class="doc-content" tabindex="-1" aria-label="Document content">
            <article class="prose doc-article">
                @((MarkupString)_html)
            </article>

            <footer class="doc-footer">
                <hr />
                <p class="muted">
                    Found an issue? Edit the markdown and submit a PR.
                </p>
            </footer>
        </main>
    </div>
}


@code {
    [Parameter] public string? slug { get; set; }

    private string _title = "Loading...";
    private string? _description;
    private string? _ogImage;
    private string? _squareImage;

    private string? _canonical;
    private bool _noIndex;

    private bool _notFound;
    private string? _html;
    private string _pageTitleFull = "Loading...";
    private string _jsonLd = "";
    private NavNode? _nav;
    private string _navRootSlug = "";
    private List<DocEntry> _children = new();
    private RenderFragment RenderNav(NavNode node) => @<ul class="nav-list nav-list--nested">
@foreach (var child in node.Children)
    {
    var isOpen = child.IsAncestorOfCurrent;
    <li class="nav-item">
        <a class="nav-link @(child.IsCurrent ? "is-current" : "")"
           href="@ToGuideRoute(child.Slug)"
           aria-current="@(child.IsCurrent ? "page" : null)">
            @child.Title
        </a>

        @if (isOpen && child.Children.Any())
                {
        @RenderNav(child)
                }
    </li>
    }
</ul>;
private string HeroStyle
        => string.IsNullOrWhiteSpace(_ogImage)
            ? ""
            : $"--hero-image: url('{ToAbsolute(_ogImage)}');";
private string ToGuideRoute(string contentSlug)
{
    contentSlug = (contentSlug ?? "").Trim('/').Replace('\\', '/');

    // the page route is already /guide/{**slug}
    if (contentSlug.Equals("guide", StringComparison.OrdinalIgnoreCase))
        return "/guide";

    if (contentSlug.StartsWith("guide/", StringComparison.OrdinalIgnoreCase))
        contentSlug = contentSlug["guide/".Length..];

    // If the slug accidentally contains ".md", remove it
    if (contentSlug.EndsWith(".md", StringComparison.OrdinalIgnoreCase))
        contentSlug = contentSlug[..^3].TrimEnd('/');

    // Map "timer/index" to "/guide/timer" (nicer URLs)
    if (contentSlug.EndsWith("/index", StringComparison.OrdinalIgnoreCase))
        contentSlug = contentSlug[..^"/index".Length].TrimEnd('/');

    return string.IsNullOrWhiteSpace(contentSlug) ? "/guide" : $"/guide/{contentSlug}";
}

protected override async Task OnParametersSetAsync()
{
    var ctx = HttpContextAccessor.HttpContext!;
    var host = ctx.Request.Host.Host;

    var (doc, _) = await Store.TryGetByRequestAsync(slug, host);
    var normalized = (slug ?? "").Trim('/');


    _navRootSlug = Store.GetNavRootSlug(normalized);
    _nav = Store.BuildNavTree(_navRootSlug, normalized);


    if (doc is null)
    {
        _notFound = true;
        _title = "Not found";
        _description = null;
        _ogImage = null;
        _squareImage = doc.SquareImage;

        _noIndex = true;
        _canonical = BuildCanonical(ctx, slug ?? "");
        return;
    }

    _notFound = false;
    _title = doc.Title;
    _description = doc.Description;
    _ogImage = doc.OgImage;
    _squareImage = doc.SquareImage;

    _noIndex = doc.NoIndex;
    _canonical = BuildCanonical(ctx, doc.Slug, doc.Canonical);

    _pageTitleFull = $"{_title} | {Brand.SiteName}";

    var ogAbs = !string.IsNullOrWhiteSpace(_ogImage)
        ? ToAbsolute(_ogImage)
        : (!string.IsNullOrWhiteSpace(Brand.DefaultOgImage) ? ToAbsolute(Brand.DefaultOgImage) : null);

    _jsonLd = BuildJsonLd(_pageTitleFull, _description ?? Brand.Tagline, _canonical, ogAbs);

    _html = Renderer.ToHtml(doc.Html);


}

private string BuildCanonical(HttpContext ctx, string? contentSlug, string? canonicalOverride = null)
{
    if (!string.IsNullOrWhiteSpace(canonicalOverride))
        return canonicalOverride.Trim();

    var baseUrl = $"{ctx.Request.Scheme}://{ctx.Request.Host}".TrimEnd('/');

    // Use the same routing rules as the UI links
    var path = ToGuideRoute(contentSlug ?? ""); // returns "/guide" or "/guide/{slug}"

    return baseUrl + path;
}


private string ToAbsolute(string urlOrPath)
{
    if (string.IsNullOrWhiteSpace(urlOrPath)) return urlOrPath;

    if (urlOrPath.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
        urlOrPath.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
        return urlOrPath;

    var ctx = HttpContextAccessor.HttpContext!;
    var baseUrl = $"{ctx.Request.Scheme}://{ctx.Request.Host}".TrimEnd('/');
    if (!urlOrPath.StartsWith('/')) urlOrPath = "/" + urlOrPath;
    return baseUrl + urlOrPath;
}

private string BuildJsonLd(string pageTitle, string? description, string canonical, string? ogImageAbs)
{
    static string J(string? s) =>
        (s ?? "").Replace("\\", "\\\\").Replace("\"", "\\\"");

    var siteName = Brand.SiteName;
    var tagline = Brand.Tagline;

    // WebSite + WebPage/Article
    return $@"
{{
  ""@context"": ""https://schema.org"",
  ""@graph"": [
    {{
      ""@type"": ""WebSite"",
      ""name"": ""{J(siteName)}"",
      ""url"": ""{J($"{HttpContextAccessor.HttpContext!.Request.Scheme}://{HttpContextAccessor.HttpContext!.Request.Host}/")}"" ,
      ""description"": ""{J(tagline)}""
    }},
    {{
      ""@type"": ""WebPage"",
      ""name"": ""{J(pageTitle)}"",
      ""url"": ""{J(canonical)}"",
      ""description"": ""{J(description)}""
      {(string.IsNullOrWhiteSpace(ogImageAbs) ? "" : $@", ""primaryImageOfPage"": {{ ""@type"": ""ImageObject"", ""url"": ""{J(ogImageAbs)}"" }}")}
    }}
  ]
}}".Trim();
}

}
