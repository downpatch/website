@page "/guide/{**slug}"
@using Microsoft.AspNetCore.Components.Web
@using downpatch.Data
@using downpatch.Services
@inject MarkdownStore Store
@inject MarkdownRenderer Renderer
@inject NavigationManager Nav
@inject IHttpContextAccessor HttpContextAccessor
@inject SiteBranding Brand

<PageTitle>@PageTitleFull</PageTitle>

<HeadContent>
    <meta name="application-name" content="@Brand.SiteName" />
    @if (!string.IsNullOrWhiteSpace(Brand.ThemeColor))
    {
        <meta name="theme-color" content="@Brand.ThemeColor" />
    }

    @if (!string.IsNullOrWhiteSpace(Canonical))
    {
        <link rel="canonical" href="@Canonical" />
        <meta property="og:url" content="@Canonical" />
    }

    @if (!string.IsNullOrWhiteSpace(Description))
    {
        <meta name="description" content="@Description" />
    }

    <meta property="og:site_name" content="@Brand.SiteName" />
    <meta property="og:title" content="@PageTitleFull" />
    <meta property="og:type" content="article" />

    @if (!string.IsNullOrWhiteSpace(Description))
    {
        <meta property="og:description" content="@Description" />
    }

    @if (!string.IsNullOrWhiteSpace(SquareImageAbs))
    {
        <meta property="og:image" content="@SquareImageAbs" />
        <meta property="og:image:width" content="1024" />
        <meta property="og:image:height" content="1024" />
    }

    <meta name="twitter:title" content="@PageTitleFull" />
    @if (!string.IsNullOrWhiteSpace(Description))
    {
        <meta name="twitter:description" content="@Description" />
    }

    @if (!string.IsNullOrWhiteSpace(Brand.TwitterHandle))
    {
        <meta name="twitter:site" content="@Brand.TwitterHandle" />
    }

    @if (NoIndex)
    {
        <meta name="robots" content="noindex,nofollow" />
    }

    <script type="application/ld+json">@_jsonLd</script>
</HeadContent>

@if (_notFound)
{
    <h1>Not found</h1>
    <p>That page doesn’t exist.</p>
}
else if (_html is null)
{
    <p>Loading...</p>
}
else
{
    <a class="skip-link" href="#doc-content">Skip to content</a>

    <header class="doc-hero2" style="@HeroStyle" aria-labelledby="doc-title">
        <div class="doc-hero2-inner">
            <div class="doc-hero2-meta">
                <p class="doc-kicker">Guide</p>
                <h1 id="doc-title" class="doc-title">@Title</h1>

                @if (!string.IsNullOrWhiteSpace(Description))
                {
                    <p class="doc-lead">@Description</p>
                }

                <div class="doc-actions" role="navigation" aria-label="Document actions">
                    <a class="doc-action" href="/guide">
                        <i class="bi bi-file-earmark-text"></i>
                        All guides
                    </a>

                    @if (!string.IsNullOrWhiteSpace(Canonical))
                    {
                        <a class="doc-action" href="@Canonical">
                            <i class="bi bi-link-45deg"></i>
                            Permalink
                        </a>
                    }

                    @if (!string.IsNullOrWhiteSpace(LeaderboardUrl))
                    {
                        <a class="doc-action" href="@LeaderboardUrl">
                            <i class="bi bi-trophy"></i>
                            Leaderboard
                        </a>
                    }

                    @if (!string.IsNullOrWhiteSpace(DiscordUrl))
                    {
                        <a class="doc-action" href="@DiscordUrl">
                            <i class="bi bi-discord"></i>
                            Discord
                        </a>
                    }
                </div>
            </div>
        </div>
    </header>

    <div class="doc-shell">
        @if (_nav is not null)
        {
            <nav class="doc-nav" aria-label="Guide navigation">
                <div class="nav-card">
                    <div class="nav-head">
                        <h2 class="nav-title">Contents</h2>
                    </div>

                    <div class="nav-body">
                        <ul class="nav-list">
                            <li class="nav-item">
                                <a class="nav-link @(_nav.IsCurrent ? "is-current" : "")"
                                   href="@ToGuideRoute(_nav.Slug)"
                                   aria-current="@(_nav.IsCurrent ? "page" : null)">
                                    @_nav.Title
                                </a>
                            </li>
                        </ul>

                        @if (_nav.Children.Any())
                        {
                            @RenderNav(_nav)
                        }
                    </div>
                </div>
            </nav>
        }

        <main id="doc-content" class="doc-content" tabindex="-1" aria-label="Document content">
            <article class="prose doc-article">
                @((MarkupString)_html)
            </article>

            <footer class="doc-footer">
                <hr />
                <p class="muted">
                    Found an issue? Edit the markdown and submit a PR.
                </p>
            </footer>
        </main>
    </div>
}

@code {
    [Parameter] public string? slug { get; set; }

    private MarkdownDoc? _doc;
    private bool _notFound;

    private string? _html;
    private string _canonical = "";
    private string _pageTitleFull = "Loading...";
    private string _jsonLd = "";

    private NavNode? _nav;
    private string _navRootSlug = "";

    // ---- computed doc fields ----
    private string Title => _doc?.Title ?? (_notFound ? "Not found" : "Loading...");
    private string? Description => _doc?.Description;
    private bool NoIndex => _doc?.NoIndex ?? _notFound;

    private string Canonical => _canonical;
    private string PageTitleFull => _pageTitleFull;

    private string? LeaderboardUrl => _doc?.LeaderboardUrl;
    private string? DiscordUrl => _doc?.DiscordURL;

    private string? OgImagePath => !string.IsNullOrWhiteSpace(_doc?.OgImage) ? _doc!.OgImage : Brand.DefaultOgImage;
    private string? SquareImagePath => _doc?.SquareImage;

    private string? OgImageAbs => !string.IsNullOrWhiteSpace(OgImagePath) ? ToAbsolute(OgImagePath!) : null;
    private string? SquareImageAbs => !string.IsNullOrWhiteSpace(SquareImagePath) ? ToAbsolute(SquareImagePath!) : null;

    private string HeroStyle
        => !string.IsNullOrWhiteSpace(OgImageAbs)
            ? $"--hero-image: url('{OgImageAbs}');"
            : "";

    private RenderFragment RenderNav(NavNode node) => @<ul class="nav-list nav-list--nested">
@foreach (var child in node.Children)
    {
    var isOpen = child.IsAncestorOfCurrent;
    <li class="nav-item">
        <a class="nav-link @(child.IsCurrent ? "is-current" : "")"
           href="@ToGuideRoute(child.Slug)"
           aria-current="@(child.IsCurrent ? "page" : null)">
            @child.Title
        </a>

        @if (isOpen && child.Children.Any())
                {
        @RenderNav(child)
                }
    </li>
    }
</ul>;

    protected override async Task OnParametersSetAsync()
    {
        var ctx = HttpContextAccessor.HttpContext!;
        var host = ctx.Request.Host.Host;

        var (doc, _) = await Store.TryGetByRequestAsync(slug, host);
        _doc = doc;

        var normalized = (slug ?? "").Trim('/');
        _navRootSlug = Store.GetNavRootSlug(normalized);
        _nav = Store.BuildNavTree(_navRootSlug, normalized);

        _notFound = doc is null;

        // canonical works even for not-found
        _canonical = _notFound
            ? BuildCanonical(ctx, slug ?? "")
            : BuildCanonical(ctx, doc!.Slug, doc.Canonical);

        _pageTitleFull = $"{Title} | {Brand.SiteName}";

        _jsonLd = BuildJsonLd(
            _pageTitleFull,
            Description ?? Brand.Tagline,
            _canonical,
            OgImageAbs
        );

        _html = _notFound ? null : Renderer.ToHtml(doc!.Html);
    }

    private string ToGuideRoute(string contentSlug)
{
    contentSlug = (contentSlug ?? "").Trim('/').Replace('\\', '/');

    if (contentSlug.Equals("guide", StringComparison.OrdinalIgnoreCase))
        return "/guide";

    if (contentSlug.StartsWith("guide/", StringComparison.OrdinalIgnoreCase))
        contentSlug = contentSlug["guide/".Length..];

    if (contentSlug.EndsWith(".md", StringComparison.OrdinalIgnoreCase))
        contentSlug = contentSlug[..^3].TrimEnd('/');

    if (contentSlug.EndsWith("/index", StringComparison.OrdinalIgnoreCase))
        contentSlug = contentSlug[..^"/index".Length].TrimEnd('/');

    return string.IsNullOrWhiteSpace(contentSlug) ? "/guide" : $"/guide/{contentSlug}";
}

private string BuildCanonical(HttpContext ctx, string? contentSlug, string? canonicalOverride = null)
{
    if (!string.IsNullOrWhiteSpace(canonicalOverride))
        return canonicalOverride.Trim();

    var baseUrl = $"{ctx.Request.Scheme}://{ctx.Request.Host}".TrimEnd('/');
    var path = ToGuideRoute(contentSlug ?? "");
    return baseUrl + path;
}

private string ToAbsolute(string urlOrPath)
{
    if (string.IsNullOrWhiteSpace(urlOrPath)) return urlOrPath;

    if (urlOrPath.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
        urlOrPath.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
        return urlOrPath;

    var ctx = HttpContextAccessor.HttpContext!;
    var baseUrl = $"{ctx.Request.Scheme}://{ctx.Request.Host}".TrimEnd('/');
    if (!urlOrPath.StartsWith('/')) urlOrPath = "/" + urlOrPath;
    return baseUrl + urlOrPath;
}

private string BuildJsonLd(string pageTitle, string? description, string canonical, string? ogImageAbs)
{
    static string J(string? s) =>
        (s ?? "").Replace("\\", "\\\\").Replace("\"", "\\\"");

    var siteName = Brand.SiteName;
    var tagline = Brand.Tagline;

    return $@"
{{
  ""@context"": ""https://schema.org"",
  ""@graph"": [
    {{
      ""@type"": ""WebSite"",
      ""name"": ""{J(siteName)}"",
      ""url"": ""{J($"{HttpContextAccessor.HttpContext!.Request.Scheme}://{HttpContextAccessor.HttpContext!.Request.Host}/")}"",
      ""description"": ""{J(tagline)}""
    }},
    {{
      ""@type"": ""WebPage"",
      ""name"": ""{J(pageTitle)}"",
      ""url"": ""{J(canonical)}"",
      ""description"": ""{J(description)}""
      {(string.IsNullOrWhiteSpace(ogImageAbs) ? "" : $@", ""primaryImageOfPage"": {{ ""@type"": ""ImageObject"", ""url"": ""{J(ogImageAbs)}"" }}")}
    }}
  ]
}}".Trim();
}
}
